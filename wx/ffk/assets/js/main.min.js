/** 
 * -------------------------------------------------------------
 * Copyright (c) 2015 iamocean All rights reserved. 
 * ------------------------------------------------------------- 
 */

(function(a) {
    //判断是否为微信环境
    function isWeiXin() {
        var ua = window.navigator.userAgent.toLowerCase();
        if (ua.match(/MicroMessenger/i) == 'micromessenger') {
            return true;
        } else {
            return false;
        }
    }

    var b = "ontouchend" in a ? "touchend" : "mousedown";
    var FanFan = a.FanFan = {
        init: function() { // 初始化 
            var a = this,
                b = $("#js-loading");
            b.removeClass("fadeIn fadeOut").addClass("fadeIn").show();
            
            var c = a.Resource;
            a.Preload.loadImg(c, function(c) {
                b.hide();
                a.render();
            });
        },
        render: function() {
            this.gameReady(), this.bindEvent()
        },
        resizeGrids: function() { // 重置窗口大小
            var b = $("#js-grids"),
                c = $(a).width();
            c = c > 640 ? 640 : c, b.css({
                width: c + "px",
                height: c + "px"
            })
        },
        bindEvent: function() { // 绑定事件
            var a = this,
                c = $("#js-btn-start"),
                d = $("#js-btn-again");
            // $("#js-btn-more");
            c.off(b).on(b, function() {
                a.gameIn()
            });
            d.off(b).on(b, function() {
                a.gameIn()
            })
        },
        gameReady: function() { // 游戏开始
            var a = $("#js-gameready");
            a.removeClass("fadeIn fadeOut").addClass("fadeIn").show()
        },
        gameIn: function() { // 进入游戏
            var b = $("#js-score"),
                // c = ($("#js-gameready"), $("#js-gamein")),
                c = $("#js-gamein"),
                d = $(".page");
            b.html(0);
            
            this.resizeGrids();
            d.hide();
            c.removeClass("fadeIn fadeOut").addClass("fadeIn").show();
            this.gameLevel = 0;
            this.score = 0;
            this.createLevel(0);
        },
        createLevel: function(a) { // 创建对应等级的关卡
            var b = $("#js-grids"), // 舞台
                c = "", // 方格 li
                d = this.Map, // 关卡配置
                e = d.level; // 所有关卡
            
            a > e.length - 1 && (a = e.length - 1); // 关卡超过永远最后一关
            
            var f = e[a], // 当前关卡配置
                g = f.mode, // 格子模式 2 4 6 8格子
                h = f.pattern, // 关卡图片数组
                i = h.length; // 图片个数
                
            this.countLen = g * g / 2; // 图片对数，多少对图片
            
            var pics = [];
            for (var x=0, l=this.countLen; x<l; x++) { // 生成指定对数图片
                var li = '<li class="item-card" data-type="' + h[x % i] + '"><div class="cardback"></div><div class="cardfront fanfan-' + h[x % i] + '"></div></li>';
                pics.push(li, li);
            }
            pics.sort(this.randomSort); // 打乱
            c = pics.join(""); // 合并数组
            
            b.removeClass("lv-2 lv-4 lv-6 lv-8").addClass("lv-" + g).find("ul").html(c);
            this.gameLogic(); // 游戏逻辑
            this.countdown(a); // 对应等级的倒计时
        },
        countdown: function(level) { // 倒计时
            var a = this,
                b = $("#js-time");
            
            a.levelTime = a.Map.level[level].time; // 游戏时间
            b.html(a.timeFormat(a.levelTime));
            
            a.timer && clearInterval(a.timer);
            a.timer = setInterval(function() {
                if (a.levelTime--, a.levelTime < 0) return void a.gameTimeOut();
                var c = a.timeFormat(a.levelTime);
                b.html(c);
            }, 1e3);
        },
        gameLogic: function() { // 游戏逻辑
            var a = this,
                c = null,
                d = 0, // 已翻牌数量
                e = $("#js-grids");
                
            e.off(b, ".item-card");
            e.on(b, ".item-card", function() {
                var b = $(this); // 当前牌
                b.removeClass("item-card").addClass("current"); // 翻开
                
                if (null == c) { // 翻开一对牌的第一张
                    c = b;
                } else if (c.data("type") === b.data("type")) { // 两张相同
                    b.add(c).removeClass("item-card").addClass("current");
                    c = null; // 清除翻牌
                    d++;
                    a.calcScore(); // 计分
                } else { // 翻错
                    setTimeout(function() { // 0.3 秒后翻回去
                        c && c.removeClass("current").addClass("item-card");
                        b.removeClass("current").addClass("item-card");
                        c = null;
                    }, 300);
                }
                
                if (d === a.countLen) { // 是否结束
                    setTimeout(function() { // 下一关
                        a.nextLevel();
                    }, 300);
                    d = 0; // 重新计数
                } 
            });
        },
        nextLevel: function() { // 过关
            this.gameLevel += 1;
            this.createLevel(this.gameLevel);
        },
        gameOver: function() { // 游戏结束
            var self = this,
                a = $("#js-gameover"),
                b = $("#js-gameover-percent"),
                c = $("#js-gameover-score");
                
            clearInterval(self.timer);
            self.timer = null;
            self.levelTime = 0;
            
            var d = self.calcPercent(self.score);
            b.html(d);
            c.html(self.score);
            
            wx_share(self.score, d); // 微信分享标题
            a.removeClass("fadeIn fadeOut").addClass("fadeIn").show();
            
            if (isWeiXin()) {
                // $("#js-btn-more, .share-tips").show();
                $(".share-tips").show();
            } else {
                // $("#js-btn-more, .share-tips").hide();
                $(".share-tips").hide();
            }
        },
        gameTimeOut: function() { // 时间到
            var a = this,
                b = $("#js-timeout");
            
            b.addClass("pop").show();
            setTimeout(function() {
                b.removeClass("pop").hide();
                a.gameOver();
            }, 800);
        },
        calcScore: function() { // 增加积分
            var a = $("#js-score");
            this.score += 2;
            a.text(this.score).addClass("pop");
            
            setTimeout(function() {
                a.removeClass("pop");
            }, 100);
        },
        calcPercent: function(a) { // 计算结果百分比
            var b = 0,
                c = parseInt(10 * Math.random());
            
            if (a === b) { // 0 分
                return b;
            } else if (30 >= a) { // 1-30
                b = .02 * a * 100;
            } else if (a > 30 && 40 > a) { // 31-39
                b = .02 * a * 100 + 10;
            } else if (a >= 40 && 50 >= a) { // 40-50
                b = Math.round(10 * (a / 10 / 2 - 2)) + 90;
            } else if (a > 50 && 70 >= a) { // 51-70
                b = Math.round(10 * (a / 10 / 2 - 2)) / 2 + 92.5;
            } else { // 70 以上
                b = 100;
            }
            b = b.toFixed(1);
            
            if (100 > b) { // 拼接小数 "2.0" + 1
                b += c;
            }
            return b;
        },
        randomSort: function() { // 打乱数组
            return Math.random() - .5;
        },
        timeFormat: function(a) {
            var b = "",
                c = "",
                d = "",
                e = Math.floor(a / 60),
                f = a % 60;
            c = 10 > e ? "0" + e : e, d = 10 > f ? "0" + f : f;
            var b = c + ":" + d;
            return b
        }
    };


    // 定义资源，预加载
    FanFan.Resource = [
        "./assets/img/logo.png", 
        "./assets/img/btn-start.png", 
        "./assets/img/icon-score.png", 
        "./assets/img/icon-time.png", 
        "./assets/img/cardback-bg.png", 
        "./assets/img/share-tips.png", 
        "./assets/img/fanfan-01.png", 
        "./assets/img/fanfan-02.png", 
        "./assets/img/fanfan-03.png", 
        "./assets/img/fanfan-04.png", 
        "./assets/img/fanfan-05.png", 
        "./assets/img/fanfan-06.png", 
        "./assets/img/fanfan-07.png", 
        "./assets/img/fanfan-08.png", 
        "./assets/img/fanfan-09.png", 
        "./assets/img/fanfan-10.png", 
        "./assets/img/fanfan-11.png", 
        "./assets/img/fanfan-12.png", 
        "./assets/img/fanfan-13.png", 
        "./assets/img/fanfan-14.png", 
        "./assets/img/fanfan-15.png", 
        "./assets/img/fanfan-16.png"
    ];

    FanFan.Preload = {
        loadImg: function(a, b) {
            function c() {
                d++;
                var a = $("#js-percent"),
                    c = Math.floor(d / e * 100);
                a.html(c), d >= e && setTimeout(function() {
                    b(f)
                }, 100)
            }
            var d = 0,
                e = 0,
                f = a instanceof Array ? [] : {};
            for (var g in a) e++, f[g] = new Image, f[g].onload = c, f[g].onerror = c, f[g].onabort = c, f[g].src = a[g]
        }
    };

    
    // 关卡设定
    FanFan.Map = {
        level: [{
            time: 20,
            mode: 2,
            pattern: ["01", "02"]
        }, {
            time: 20,
            mode: 2,
            pattern: ["03", "04"]
        }, {
            time: 30,
            mode: 4,
            pattern: ["05", "06", "07", "08"]
        }, {
            time: 30,
            mode: 4,
            pattern: ["09", "10", "11", "12"]
        }, {
            time: 30,
            mode: 4,
            pattern: ["13", "14", "15", "16"]
        }, {
            time: 40,
            mode: 4,
            pattern: ["01", "02", "03", "04", "05", "06", "07", "08"]
        }, {
            time: 40,
            mode: 4,
            pattern: ["09", "10", "11", "12", "13", "14", "15", "16"]
        }, {
            time: 60,
            mode: 6,
            pattern: ["01", "02", "03", "04"]
        }, {
            time: 60,
            mode: 6,
            pattern: ["05", "06", "07", "08", "09", "10"]
        }, {
            time: 60,
            mode: 6,
            pattern: ["11", "12", "13", "14", "15", "16"]
        }, {
            time: 60,
            mode: 6,
            pattern: ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"]
        }, {
            time: 90,
            mode: 8,
            pattern: ["01", "02", "03", "04", "05", "06", "07", "08"]
        }, {
            time: 90,
            mode: 8,
            pattern: ["09", "10", "11", "12", "13", "14", "15", "16"]
        }, {
            time: 120,
            mode: 8,
            pattern: ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16"]
        }]
    };

    function wx_share(score, percent) { // 分享
        document.title = "「翻翻看」我获得了"+score+"分，击败了全国"+percent+"%的人，等你来挑战。";
    }

    FanFan.init();// 初始化游戏
})(window);